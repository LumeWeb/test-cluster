projects:
  - name: services
    dir: layers/services
    opentofu: true
    depends_on: ["core"]
    include_patterns: ["../core/**"]
  - name: core
    dir: layers/core
    opentofu: true

workflows:
  default:
    plan:
      steps:
        - run: |
            pwd
            ls -la ./scripts/
        - run: "./scripts/s3_backend.sh"
          shell: bash
        - init:
            extra_args: ["-backend-config=backend.hcl", "-migrate-state"]
        - plan
    apply:
      steps:
        - run: "./scripts/s3_backend.sh"
          shell: bash
        - init:
            extra_args: ["-backend-config=backend.hcl"]
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"] 
      on_commit_to_default: ["digger unlock"]